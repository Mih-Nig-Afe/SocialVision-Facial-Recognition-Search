# SocialVision Docker Compose Configuration
# Multi-backend upscaling with Real-ESRGAN, OpenCV, and Lanczos fallback
# IBM MAX is disabled by default (incompatible with ARM64/Apple Silicon)

services:
  # IBM MAX Image Resolution Enhancer (DISABLED - x86 only)
  # Uncomment on x86 systems if you want IBM MAX upscaling
  # ibm-max:
  #   image: quay.io/codait/max-image-resolution-enhancer
  #   container_name: ibm-max
  #   ports:
  #     - "5100:5000"  # Use 5100 externally (5000 often used by AirPlay on macOS)
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 2G
  #       reservations:
  #         memory: 512M
  #   restart: on-failure:3
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:5000/model/metadata"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 120s

  socialvision:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: socialvision-app
    env_file:
      - .env
    ports:
      - "8501:8501"  # Streamlit
      - "8000:8000"  # FastAPI (optional)
    volumes:
      - ./src:/app/src
      - ./data:/app/data
      - ./uploads:/app/uploads
      - ./logs:/app/logs
      - ./models:/app/models
      - ./config:/app/config
      - ./.streamlit:/app/.streamlit
      - deepface-cache:/root/.deepface
    environment:
      - PYTHONUNBUFFERED=1
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_LOGGER_LEVEL=info
      # DB configuration is sourced from `.env` (env_file) so Docker and local
      # runs behave the same. Recommended: DB_TYPE=firebase for
      # Firestore -> Realtime DB -> local fallback.
      # Force Realtime DB to avoid Firestore free-tier read quota exhaustion.
      - DB_TYPE=realtime
      # Optional: seed Realtime DB once from local JSON when RTDB root is empty.
      - REALTIME_BOOTSTRAP_FROM_LOCAL=true
      # Optional: seed Firestore once from local JSON when Firestore is empty.
      - FIRESTORE_BOOTSTRAP_FROM_LOCAL=true
      # Reduce Firestore reads from Streamlit reruns.
      - FIRESTORE_STATS_CACHE_TTL_SECONDS=30
      # Be tolerant of transient throttling.
      - FIRESTORE_REST_MAX_RETRIES=8
      # IBM MAX disabled on ARM64/Apple Silicon (enable on x86 systems)
      - IBM_MAX_ENABLED=false
      - IBM_MAX_URL=http://ibm-max:5000
      - IBM_MAX_TIMEOUT=60
      - IBM_MAX_PROBE_ON_START=false
      - IBM_MAX_FAILURE_THRESHOLD=2
      # Multi-backend extraction: try all backends, aggregate results
      - MULTI_BACKEND_EXTRACTION=true
      - IMAGE_UPSCALING_ENABLED=true
      # Use Real-ESRGAN for highest fidelity (Docker memory limit capped at 12G)
      - IMAGE_UPSCALING_BACKEND=realesrgan_x6plus
      # Fallback chain: Real-ESRGAN -> OpenCV -> Lanczos for constrained hosts
      - IMAGE_UPSCALING_BACKEND_PRIORITY=realesrgan,opencv,lanczos
      # Memory-aware tiling keeps VRAM usage manageable for multi-pass 8x runs
      - IMAGE_UPSCALING_TILE=192
      - IMAGE_UPSCALING_TILE_PAD=16
      - IMAGE_UPSCALING_TARGET_SCALE=8.0
      - IMAGE_UPSCALING_MIN_EDGE=320
      - IMAGE_UPSCALING_MAX_EDGE=4096
      - IMAGE_UPSCALING_MAX_PASSES=2
    # Memory cap managed via Docker Desktop/Engine (set to 12G now); keep deploy block commented for non-Swarm usage
    # deploy:
    #   resources:
    #     limits:
    #       memory: 12G
    #     reservations:
    #       memory: 4G
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  socialvision-tests:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: socialvision-tests
    env_file:
      - .env
    volumes:
      - ./src:/app/src
      - ./data:/app/data
      - ./uploads:/app/uploads
      - ./logs:/app/logs
      - ./models:/app/models
      - ./config:/app/config
      - ./.streamlit:/app/.streamlit
    environment:
      - PYTHONUNBUFFERED=1
      # Avoid external service dependencies during test runs.
      - IBM_MAX_ENABLED=false
      - DEEPFACE_ENABLED=false
      - FIREBASE_ENABLED=false
      - DB_TYPE=local
    command: ["python", "-m", "pytest", "-q"]

networks:
  socialvision-network:
    driver: bridge

volumes:
  data:
  uploads:
  logs:
  models:
  config:
  deepface-cache:

